easyblock = 'CMakeMake'

name = 'RDKit'
version = '2019.03.4'

homepage = 'http://www.rdkit.org/'
description = """RDKit is a collection of cheminformatics and machine-learning software written in C++ and Python."""

toolchain = {'name': 'GCC', 'version': '7.3.0' }
toolchainopts = {'opt': True}

source_urls = ['https://github.com/rdkit/rdkit/archive']
sources = ['Release_%s.tar.gz' % version.replace('.','_')]

# Py2 is not supported anymore. Bye bye Py2!
multi_deps_load_default = False
multi_deps = {"Python": ["3.5.4","3.6.3","3.7.4"]}

builddependencies = [
    ('CMake', '3.12.3'),
    ('Eigen', '3.3.5'),
    ('SciPy-Stack', '2019a'),
]

dependencies = [
    ('Boost', '1.68.0'),
]

configopts = " ".join([
    "-DBOOST_ROOT=$EBROOTBOOST",
    "-DCMAKE_SKIP_RPATH=ON",
    "-DRDK_INSTALL_INTREE=OFF",
    "-DRDK_OPTIMIZE_NATIVE=OFF",
    "-DRDK_BUILD_CPP_TESTS=OFF",

    "-DPYTHON_VERSION_MAJOR=3",
    "-DPYTHON_EXECUTABLE=$EBROOTPYTHON/bin/python",
    "-DPYTHON_INCLUDE_DIR=$EBROOTPYTHON/include/python%(pyshortver)sm",
    "-DPYTHON_LIBRARY=$EBROOTPYTHON/lib/libpython%(pyshortver)sm.so",
    "-DPYTHON_NUMPY_INCLUDE_PATH=$EBROOTSCIPYMINSTACK/lib/python%(pyshortver)s/site-packages/numpy/core/include",
])

postinstallcmds = [
    "/cvmfs/soft.computecanada.ca/easybuild/bin/setrpaths.sh --path %(installdir)s/lib/python%(pyshortver)s/site-packages --add_path %(installdir)s/lib",
]

modextrapaths = { 'EBPYTHONPREFIXES' : '' }
moduleclass = 'chem'
separate_build_dir = True
sanity_check_paths = {
    'files': [
        "lib/libRDKitEigenSolvers.so",
        "lib/libRDKitRDBoost.so",
        "lib/libRDKitRDGeneral.so",
        "lib/python%(pyshortver)s/site-packages/rdkit/rdBase.so",
        "lib/python%(pyshortver)s/site-packages/rdkit/RDConfig.py",
    ],
    'dirs': []
}
