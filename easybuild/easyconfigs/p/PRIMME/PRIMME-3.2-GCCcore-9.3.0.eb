easyblock = 'ConfigureMake'

name = 'PRIMME'
version = '3.2'

homepage = 'http://www.cs.wm.edu/~andreas/software/'
description = """PRIMME, pronounced as prime, is a high-performance library for computing a few eigenvalues/eigenvectors, and singular values/vectors.
PRIMME is especially optimized for large, difficult problems.
Real symmetric and complex Hermitian problems, standard A x = \lambda x and generalized A x = \lambda B x, are supported.
Besides, standard eigenvalue problems with a normal matrix are supported.
It can find largest, smallest, or interior singular/eigenvalues, and can use preconditioning to accelerate convergence.
"""
toolchain = {'name': 'GCCcore', 'version': '9.3.0'}
toolchainopts = {'pic': True}

builddependencies = [
    ('SciPy-Stack', '2023a'),
]
multi_deps = {'Python': ['3.9', '3.10']} #Python extention not compatible with Python 3.11

source_urls = [
    'https://github.com/primme/primme/archive/refs/tags/',
]
sources = ['v%(version)s.tar.gz']
patches = ['PRIMME-3.2-fix-include-python.patch']
checksums = [
    '8ff242a356cea465c9728a26cb6e0487712d9ae51050a362de487e3b13a2fe9b', #sources
    '62f73a5ffbd6fd7908f055c51d0b01cce423d88cb2bbbacecea8977ee6691000', #patch
]

# No configure
skipsteps = ['configure']

# Build static and shared libraries
build_cmd = "make lib && make solib"

# Custom install because target "make install" does not work
# Note we can't use the "MakeCp" easyblock because we use installopts
# to install the Python extention
install_cmd = " && ".join([
    "cd %(builddir)s/primme-%(version)s",
    "cp -r lib %(installdir)s/lib",
    "cp -r include %(installdir)s/include",
])

# Install the Python extension
installopts = ' && '.join([
    "",
    "cd %(builddir)s/primme-%(version)s/Python",
    "mkdir -p %(installdir)s/lib/python%(pyshortver)s/site-packages",
    "python setup.py build_ext --inplace",
    "pip install --prefix=%(installdir)s .",
])

sanity_check_paths = {
    'files': ['lib/libprimme.so', 'lib/libprimme.a'],
    'dirs': [
	'lib/python%(pyshortver)s/site-packages',
	'include',
    ]
}

sanity_check_commands = [
    ('module load scipy-stack/2023a && python %(builddir)s/primme-%(version)s/Python/examples.py'),
]

modextrapaths = {'EBPYTHONPREFIXES': ''}

modluafooter = """
if convertToCanonical(LmodVersion()) >= convertToCanonical("8.2.9") then
    extensions("primme/3.1.0")
end
"""

moduleclass = 'math'
